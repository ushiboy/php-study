# 1. 文法的な話

[php.net 言語リファレンス](http://php.net/manual/ja/langref.php) を参考にざっと見ていく。


## 基本的な構文

### PHP タグ

* コードは`<?php`と`?>`で囲む
* PHPコードだけの場合は`<?php`だけにする
  * `?>`まで書くと後ろにスペース入ったりして、画面表示時に「謎のスペースが?」みたいにハマる

### HTML からの脱出

* `<?php`と`?>`で囲まれていない部分はそのまま表示される
* 条件文を使って分離する書き方も可能
    * [制御構造に関する別の構文](http://php.net/manual/ja/control-structures.alternative-syntax.php)を参考

```php
<?php if ($exp === true): ?>
  ok
<?php else: ?>
  ng
<?php endif; ?>
```

* `<?= ?>`が5.4以降から標準で使えるようになったみたい

### 命令の分離

* ステートメントの区切りはセミコロンが必要
* 終了タグ`?>`は自動的にセミコロンが含まれている扱いになる

### コメント

```php
<?php
// 1行コメント

# 1行コメント

/*
複数行コメント
*/
```

## 型

* 10種類の基本型
  * スカラー型
    * 論理値(boolean)
      * TRUEまたはFALSEのどちらか（大文字小文字区別なし）
      * FALSEとみなされるもの
        * boolean の FALSE
        * integer の 0
        * float の 0.0
        * 空の文字列 ''、 文字列の "0"
        * 要素の数がゼロである配列
        * 特別な値 NULL (値がセットされていない変数を含む)
        * 空のタグから作成された SimpleXML オブジェクト
      * 他はすべてTRUEとみなす
    * 整数(integer)
      * 10進数, 16進数, 8進数, 2進数で設定できる
        * 10進数: 1234
        * 8進数: 0123
        * 16進数: 0x1A
        * 2進数: 0b111
      * 整数のサイズはプラットフォーム依存
        * 一般的に32ビット符号付き
      * オーバーフローすると浮動小数点として解釈される
    * 浮動小数点(float, double)
      * 大きさはプラットフォーム依存
      * NANは何と比較してもFALSE
        * 他のものと比較せずに`is_nan`を使う
    * 文字列(string)
      * 引用符（クォート）: エスケープシーケンス書いてもそのままでる
      * 二重引用符（ダブルクォート）: エスケープシーケンスは展開される
  * 複合型
    * 配列(array)
      * 順序付けられたマップ（連想配列）
      * 昔は`array()`で指定
      * 今は`[]`
    * iterable
      * foreachやジェネレータでたどれる
      * Traversableインターフェイスの実装
    * オブジェクト(object)
      * newで初期化して生成
      * 詳しくはクラスとかの話で
    * callable
      * コールバック関数
  * 特別な型
    * リソース(resource)
      * ファイルとかデータベース接続のハンドル
      * [リソース一覧](http://php.net/manual/ja/resource.php)参照
    * ヌル(NULL)
      * 値を持たない
      * ヌルになるとき
        * 定数NULLが代入されたとき
        * 何も値が代入されていない時
        * unsetされた時
* 変数の型は使用される文脈に応じてPHPが実行時に決定する
* 演算子、関数、制御構造が特定の型の引数を必要とする場合、値は自動的に変換される（キャスト不要）
* キャストで明示的な変換もできる


## 変数

### 基本的な事

* `$`記号の後に変数名を続けて表現
* 変数名は大文字小文字を区別する
  * 文字またはアンダースコアから始まる
* `$this`は特別な変数なので代入不可
* 通常、変数の代入は値の代入（元の変数を変更しても変わらない）
  * 参照を代入した場合、元の変数を変えると代入先も変わる


### 定義済みの変数

* 定義済みの変数がいっぱい
  * [定義済みの変数](http://php.net/manual/ja/reserved.variables.php)を参考
* 実行するサーバ種類、バージョン、設定などに依存しているので環境で異なる
* ざっと上げると
  * `$GLOBALS`: グローバルスコープで使用可能なすべての変数への参照
  * `$_SERVER`: サーバー情報および実行時の環境情報
  * `$_GET`: HTTP GET 変数
  * `$_POST`: HTTP POST 変数
  * `$_FILES`: HTTP ファイルアップロード変数
  * `$_REQUEST`: HTTP リクエスト変数
  * `$_SESSION`: セッション変数
  * `$_ENV`: 環境変数
  * `$_COOKIE`: HTTP クッキー
  * `$php_errormsg`: 直近のエラーメッセージ
  * `$HTTP_RAW_POST_DATA`: 生の POST データ
  * `$http_response_header`: HTTP レスポンスヘッダ
  * `$argc`: スクリプトに渡された引数の数
  * `$argv`: スクリプトに渡された引数の配列
* WEBフレームワークとかに乗っかた開発だと直接触ることは少ないかも

### 変数のスコープ

* スコープの範囲はincludeやrequireで読み込まれたファイルも含む
* ユーザー定義関数の中では有効範囲も関数の中まで
* ユーザー定義関数の中でグローバル変数を使うにはglobalキーワードを使う
  * もしくは$GLOBALSから取得する
* ローカル関数の中のみで状態を保持し続ける変数の定義にstaticキーワードを使う方法がある

### 可変変数

* 変数名を動的に付けることができる
  * できるけどあまりやらない
```php
<?php
$a = 'hello';
$$a = 'world';
echo $hello; // world
```


### 外部から来る変数

* `$_GET`や`$_POST`のこと
  * [定義済みの変数](http://php.net/manual/ja/reserved.variables.php)を参考


## 定数

* 値のためのID
  * define関数で定義
  * constキーワードで定義
* スクリプト実行中に変更できない
  * マジック定数（自動的に定義される定数）は例外
    * `__FILE__`とか`__DIR__`とか
    * [自動的に定義される定数](http://php.net/manual/ja/language.constants.predefined.php)を参照
* デフォルトで大文字・小文字を区別する
  * 慣例的には大文字で表記
  * 文字またはアンダースコアで始める
  * 文字、数字、アンダースコアを使う

### 式

* ほぼ全てが式

### 演算子

* 演算子の優先順位
  * [一覧](http://php.net/manual/ja/language.operators.precedence.php)参照
* 代数演算子
  * 加算`+`
  * 減算`-`
  * 乗算`*`
  * 除算`/`
  * 剰余`%`
  * 累乗`**`
* 代入演算子
  * `=`
* ビット演算子
  * ビット積`&`
  * ビット和`|`
  * 排他的論理和`^`
  * 否定`~`
  * 左シフト`<<`
  * 右シフト`>>`
* 比較演算子
  * [型の比較表](http://php.net/manual/ja/types.comparisons.php)を参考
  * 等しい`==`
    * 型の相互変換が働く
  * 等しい`===`
    * 同じ型の場合のみ
  * 等しくない`!=`
    * 型の相互変換が働く
  * 等しくない`<>`
    * 型の相互変換が働く
  * 等しくない`!==`
    * 同じ型の場合のみ
  * より少ない`<`
  * より多い`>`
  * より少ないか等しい`<=`
  * より多いか等しい`>=`
  * 宇宙船`<=>`
    * 小さい時に負の値、等しい時に0、大きい時に正の値
    * Rubyのあれ
* 三項演算子
  * ` $a ? $b : $c;`
    * $aがTRUEの時$b, FALSEのとき$c
  * ` $a ?: $b;`
    * $aがTRUEの場合に$a,それ以外は$b
* Null合体演算子
  * `$a ?? $b`
    * $aがNULLである場合$b、それ以外は$a
    * JavaScriptとかで言うところの`||`
    * issetの代わり
* エラー制御演算子
  * `@`
  * その式によって生成されたエラーメッセージが無視される
  * まず使わない
* 実行演算子
  * バッククォートでシェルコマンド実行
  * `ls -al`
  * まあ使わない
* 加算子/減算子
  * 前置加算子`++$a`
  * 後置加算子`$a++`
  * 前置減算子`--$a`
  * 後置減算子`$a--`
* 論理演算子
  * 論理積`and`
  * 論理和`or`
  * 排他的論理和`xor`
  * 否定`!`
  * 論理積`&&`
    * `and`よりも優先順位が高い
  * 論理和`||`
    * `or`よりも優先順位が高い
* 文字列演算子
  * `.`
    * 文字列同士の結合
  * `.=`
    * 結合代入
* 配列演算子
  * 結合`+`
  * 同等`==`
  * 同一`===`
  * 等しくない`!=`
  * 等しくない`<>`
  * 同一でない`!==`
* 型演算子
  * instanceof
    * 特定のクラスのオブジェクトであるか調べる

### 制御構造

* 条件分岐
  * if, else, elseif/else if
  * switch
* ループ
  * while
  * do-while
  * for
  * foreach
* break
  * ループの終了
  * switchの終了
* continue
  * ループのスキップ
* goto
  * ラベルにジャンプ
* PHPスクリプトファイル読み込み
  * `require`
  * `include`
  * `require_once`
  * `include_once`
* declare
  * コードブロックの中に実行ディレクティブをセットする
  * 使用可能なディレクティブ
    * `tick`
      * 回数を指定して文が実行されるごとにイベントを起こす
    * `encoding`
      * スクリプトごとに文字エンコーディングを指定する
    * `strict_types`
      * 厳格な型チェックを行う

### 関数

#### ユーザー定義関数

* 参照される前に定義されている必要はない
  * 条件付きで定義される場合は除く
* すべてグローバルスコープにある
  * 関数の内部で定義したものであっても関数の外部からコールできる
* 関数のオーバーロードはできない
  * 再定義も不可
* 可変引数
* デフォルト引数

#### 関数の引数

* デフォルトは値渡し
* 参照渡し
  * `&`を引数名の前に付ける
  * 引数の変更を関数の外部に反映させる
* デフォルト引数
  * 引数名の後に`=`で設定
  * 定数式であること
  * デフォルト引数のあるものは無いものの右側へ
* 型宣言
  * パラメータが特定の方であることを要求できる
  * 関数に渡された値が不正な方であった場合エラーになる
    * PHP7ではTypeError例外がスローされる
  * 型の名前をパラメータの前に書く
  * [関数の引数:有効な型](http://php.net/manual/ja/functions.arguments.php#functions.arguments.type-declaration.types)
  * 強い型付け
    * デフォルトでは間違った型を渡されても自動変換
    * declareのstrict_typesで強くする
      * 間違った型の場合TypeErrorに
      * float指定の場所にintegerは許される
* 可変長引数リスト
  * ...で定義 `function a(...$b)`
  * 呼び出し側で `a(...[1, 2]);`とかもできる

### 返り値

* `return`
  * あらゆる型を返す
  * 任意の箇所での関数実行の終了
  * 省略した場合NULLを返す
* 多値を返すことはできない
  * 配列と受け取り側をlistにして行う

```php
<?php
function a() {
  return [1, 2];
}
list($a, $b) = a();
```

* リファレンスを返す場合
  * リファレンス演算子`&`を関数宣言部と変数への返り値を代入する際の両方で使用する
  * 詳しくはリファレンスの話で

```php
<?php
function &a() {
  return $ref;
}
$ref =& a();
```

* PHP 7以降で、戻り値の型宣言入った
* 使える型の種類は引数の型宣言で使えるものと同じ
* 厳格な型チェックはこちらでも影響を受ける
  * デフォルトは弱い片付け
    * 正しくなくても自動変換
  * 強くすると一致しない場合TypeErrorに

### 可変関数

* 変数名の後に括弧が付いている場合、値がなんであろうと同名の関数を探して実行する
  * `$fn();`
* インスタンスメソッドも
  * `$ins->$fn();`
* クラスメソッドも
  * `Foo::$fn();`

### 内部（ビルトイン）関数

* めっちゃたくさんある
* エクステンションを必要とするものもある
  * GD, MySQLなどなど
  * コンパイルオプションで指定する
  * パッケージを使っている場合は追加でインストール

### 無名関数

* クロージャ
* Closureクラスの実装
* 用途
  * 関数の引数でコールバックとして使う
  * 変数に代入して使う
* useを利用
  * 親のスコープから変数を引き継ぐ
* `$this`の扱い
  * クラスのコンテキストで宣言した場合自動的にバインドされる
  * 自動バインドしないためには
    * 静的無名関数 `static function() {`
